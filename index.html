<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: Arial, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            min-height: 100vh;
        }

        .container {
            max-width: 400px;
            margin: 0 auto;
            padding: 20px;
        }

        .title {
            text-align: center;
            margin-bottom: 30px;
            font-size: 24px;
            font-weight: bold;
        }

        .button {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            background: var(--tg-theme-button-color, #2481cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            transition: opacity 0.2s;
        }

        .button:hover {
            opacity: 0.8;
        }

        .button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .info-block {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
        }

        .response-block {
            background: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-size: 12px;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .status {
            text-align: center;
            margin: 10px 0;
            font-weight: bold;
        }

        .status.success {
            color: #22c55e;
        }

        .status.error {
            color: #ef4444;
        }

        .loading {
            text-align: center;
            color: var(--tg-theme-hint-color, #999999);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 class="title">Telegram Mini App</h1>
        
        <div class="info-block">
            <strong>Init Data –≥–æ—Ç–æ–≤–∞:</strong> <span id="initDataStatus">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</span>
        </div>

        <button class="button" id="authButton" onclick="authenticate()">
            üîê –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è
        </button>

        <button class="button" id="profileButton" onclick="getProfile()" disabled>
            üë§ –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
        </button>

        <div id="status" class="status"></div>
        
        <div id="response" class="response-block" style="display: none;"></div>
    </div>

    <script>
        let jwtTokens = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram Web App
        window.Telegram.WebApp.ready();
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å init data
        function checkInitData() {
            const initData = window.Telegram.WebApp.initData;
            const statusElement = document.getElementById('initDataStatus');
            
            if (initData) {
                statusElement.textContent = '‚úÖ –î–æ—Å—Ç—É–ø–Ω–∞';
                statusElement.style.color = '#22c55e';
                document.getElementById('authButton').disabled = false;
            } else {
                statusElement.textContent = '‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞';
                statusElement.style.color = '#ef4444';
                document.getElementById('authButton').disabled = true;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
        async function authenticate() {
            const button = document.getElementById('authButton');
            const statusElement = document.getElementById('status');
            const responseElement = document.getElementById('response');
            
            // –ü–æ–ª—É—á–∞–µ–º init data
            const initData = window.Telegram.WebApp.initData;
            
            if (!initData) {
                showStatus('–û—à–∏–±–∫–∞: Init data –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
                return;
            }

            button.disabled = true;
            button.textContent = 'üîÑ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...';
            showStatus('–û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä...', '');

            try {
                const response = await fetch('http://127.0.0.1:8003/auth/telegram', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        initData: initData
                    })
                });

                const data = await response.json();
                
                if (response.ok) {
                    jwtTokens = data;
                    showStatus('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!', 'success');
                    showResponse('–¢–æ–∫–µ–Ω—ã –ø–æ–ª—É—á–µ–Ω—ã', JSON.stringify(data, null, 2));
                    
                    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –ø—Ä–æ—Ñ–∏–ª—è
                    document.getElementById('profileButton').disabled = false;
                } else {
                    showStatus('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏', 'error');
                    showResponse('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', JSON.stringify(data, null, 2));
                }
            } catch (error) {
                showStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                showResponse('–û—à–∏–±–∫–∞', error.message);
                console.error('Auth error:', error);
            } finally {
                button.disabled = false;
                button.textContent = 'üîê –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è
        async function getProfile() {
            const button = document.getElementById('profileButton');
            const statusElement = document.getElementById('status');
            const responseElement = document.getElementById('response');
            
            if (!jwtTokens || !jwtTokens.access_token) {
                showStatus('–û—à–∏–±–∫–∞: –°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é', 'error');
                return;
            }

            button.disabled = true;
            button.textContent = 'üîÑ –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å...';
            showStatus('–ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è...', '');

            try {
                const response = await fetch('http://127.0.0.1:8003/me', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${jwtTokens.access_token}`,
                        'Content-Type': 'application/json',
                    }
                });

                const data = await response.json();
                
                if (response.ok) {
                    showStatus('‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—É—á–µ–Ω!', 'success');
                    showResponse('–î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è', JSON.stringify(data, null, 2));
                } else {
                    showStatus('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è', 'error');
                    showResponse('–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞', JSON.stringify(data, null, 2));
                }
            } catch (error) {
                showStatus('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                showResponse('–û—à–∏–±–∫–∞', error.message);
                console.error('Profile error:', error);
            } finally {
                button.disabled = false;
                button.textContent = 'üë§ –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ç—É—Å–∞
        function showStatus(message, type) {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = `status ${type}`;
        }

        // –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –æ—Ç–≤–µ—Ç–∞
        function showResponse(title, content) {
            const responseElement = document.getElementById('response');
            responseElement.style.display = 'block';
            responseElement.textContent = `${title}:\n\n${content}`;
        }

        // –ü—Ä–æ–≤–µ—Ä—è–µ–º init data –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        checkInitData();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ç–µ–º—ã Telegram
        document.body.style.background = window.Telegram.WebApp.themeParams.bg_color || '#ffffff';
        document.body.style.color = window.Telegram.WebApp.themeParams.text_color || '#000000';
    </script>
</body>
</html>
