<script>
    const BACKEND_URL = 'http://127.0.0.1:8001';

    const authBtn = document.getElementById('auth-btn');
    const protectedBtn = document.getElementById('protected-btn');
    const statusDiv = document.getElementById('status');
    const errorDiv = document.getElementById('error-message');

    // Обертка для проверки загрузки скрипта Telegram
    function initializeApp() {
        const webApp = window.Telegram?.WebApp;

        if (!webApp) {
            // Если скрипт Telegram ещё не загрузился, попробуем снова через 100 мс
            setTimeout(initializeApp, 100);
            return;
        }

        // Если initData отсутствует, это означает, что Mini App запущено не из Telegram
        if (!webApp.initData) {
            errorDiv.textContent = '❌ Ошибка: initData отсутствует. Убедитесь, что запускаете приложение из клиента Telegram.';
            return;
        }

        authBtn.addEventListener('click', authenticate);
        protectedBtn.addEventListener('click', checkProtected);

        // Теперь у нас есть initData и можно работать
        statusDiv.textContent = '✅ Telegram Mini App успешно инициализировано.';

        async function authenticate() {
            statusDiv.textContent = 'Отправка данных на бэкенд...';
            errorDiv.textContent = '';

            try {
                const response = await fetch(`${BACKEND_URL}/auth/signin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ init_data: webApp.initData }),
                });

                if (response.ok) {
                    statusDiv.textContent = '✅ Авторизация успешна!';
                    errorDiv.textContent = '';
                } else {
                    const error = await response.json();
                    errorDiv.textContent = `❌ Ошибка авторизации: ${error.detail || 'Неизвестная ошибка'}`;
                    statusDiv.textContent = '';
                }
            } catch (error) {
                errorDiv.textContent = `❌ Не удалось подключиться к бэкенду. ${error.message}`;
                statusDiv.textContent = '';
            }
        }

        async function checkProtected() {
            statusDiv.textContent = 'Проверка защищенного эндпоинта...';
            errorDiv.textContent = '';

            try {
                const response = await fetch(`${BACKEND_URL}/auth/protected`, {
                    method: 'GET',
                    credentials: 'include',
                });

                if (response.ok) {
                    const data = await response.json();
                    statusDiv.textContent = `✅ Доступ разрешен! Сообщение: "${data.message}"`;
                    errorDiv.textContent = '';
                } else {
                    const error = await response.json();
                    errorDiv.textContent = `❌ Отказано в доступе. Ошибка: ${error.detail || 'Неизвестная ошибка'}`;
                    statusDiv.textContent = '';
                }
            } catch (error) {
                errorDiv.textContent = `❌ Не удалось подключиться к бэкенду. ${error.message}`;
                statusDiv.textContent = '';
            }
        }
    }

    // Запускаем инициализацию после загрузки DOM
    document.addEventListener('DOMContentLoaded', initializeApp);
</script>
