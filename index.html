<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Mini App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        .container { max-width: 400px; margin: auto; }
        .button { width: 100%; padding: 15px; margin: 10px 0; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        .primary { background: #2481cc; color: white; }
        .secondary { background: #e0e0e0; }
        .status { margin: 10px 0; font-weight: bold; }
        .success { color: green; }
        .error { color: red; }
        pre { background: #f3f3f3; padding: 10px; border-radius: 6px; white-space: pre-wrap; word-wrap: break-word; }
    </style>
</head>
<body>
<div class="container">
    <h1>Telegram Mini App</h1>
    <p>Init Data: <span id="initStatus">–ü—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è...</span></p>
    <button id="authBtn" class="button primary" onclick="authenticate()" disabled>üîê –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è</button>
    <button id="meBtn" class="button secondary" onclick="getProfile()" disabled>üë§ –ü–æ–ª—É—á–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å</button>
    <div id="status" class="status"></div>
    <pre id="response" style="display:none;"></pre>
</div>

<script>
    window.Telegram.WebApp.ready();

    const initData = window.Telegram.WebApp.initData;
    const initStatus = document.getElementById('initStatus');
    const authBtn = document.getElementById('authBtn');
    const meBtn = document.getElementById('meBtn');
    const statusEl = document.getElementById('status');
    const responseEl = document.getElementById('response');

    if (initData) {
        initStatus.textContent = "‚úÖ –î–æ—Å—Ç—É–ø–Ω–∞";
        initStatus.style.color = "green";
        authBtn.disabled = false;
    } else {
        initStatus.textContent = "‚ùå –ù–µ–¥–æ—Å—Ç—É–ø–Ω–∞";
        initStatus.style.color = "red";
    }

    function showStatus(msg, type) {
        statusEl.textContent = msg;
        statusEl.className = `status ${type || ''}`;
    }
    function showResponse(content) {
        responseEl.style.display = 'block';
        responseEl.textContent = content;
    }

    async function authenticate() {
        showStatus("–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...", "");
        responseEl.style.display = 'none';
        authBtn.disabled = true;

        try {
            const body = new URLSearchParams({ init_data: initData });
            const res = await fetch('http://127.0.0.1:8003/auth/telegram', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body,
                credentials: 'include'
            });

            const text = await res.text();
            if (res.ok) {
                showStatus("‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞", "success");
                showResponse(text);
                meBtn.disabled = true; // –≤–∫–ª—é—á–∏–º –Ω–∏–∂–µ, –µ—Å–ª–∏ –∫—É–∫–∏ –ø—Ä–∏—à–ª–∏
                // –û–±—ã—á–Ω–æ —Å–µ—Ä–≤–µ—Ä —Å—Ç–∞–≤–∏—Ç –∫—É–∫–∏, –ø–æ—ç—Ç–æ–º—É –∫–Ω–æ–ø–∫—É /me –º–æ–∂–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É:
                meBtn.disabled = false;
            } else {
                showStatus("‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏", "error");
                showResponse(text);
            }
        } catch (err) {
            showStatus("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", "error");
            showResponse(err.message);
        } finally {
            authBtn.disabled = false;
        }
    }

    async function getProfile() {
        showStatus("–ó–∞–ø—Ä–æ—Å –ø—Ä–æ—Ñ–∏–ª—è...", "");
        responseEl.style.display = 'none';
        meBtn.disabled = true;

        try {
            const res = await fetch('http://127.0.0.1:8003/me', {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${jwtTokens.access_token}`,
                    'Accept': 'application/json'
                }
            });

            const text = await res.text();
            if (res.ok) {
                showStatus("‚úÖ –ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—É—á–µ–Ω", "success");
                showResponse(text);
            } else {
                showStatus("‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è", "error");
                showResponse(text);
            }
        } catch (err) {
            showStatus("‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è", "error");
            showResponse(err.message);
        } finally {
            meBtn.disabled = false;
        }
    }
</script>
</body>
</html>
